<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Habit Vibe 9.0 - Safe Mode</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js" crossorigin></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body { -webkit-tap-highlight-color: transparent; font-family: sans-serif; overflow-x: hidden; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .luxury-aura { 
            box-shadow: 0 0 35px rgba(251, 191, 36, 0.8); 
            border: 3px solid #fbbf24;
            animation: pulse-gold 2s infinite;
        }
        @keyframes pulse-gold {
            0% { transform: scale(1.03); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1.03); }
        }
        .magic-text {
            background: linear-gradient(90deg, #fbbf24, #f59e0b, #fbbf24);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            font-weight: 900;
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-800">
    <div id="root"></div>

    <script type="text/babel">
        // エラーが発生しても白い画面のままにしないための安全策
        window.onerror = function(msg, url, line) {
            document.body.innerHTML = '<div style="padding:20px; text-align:center;"><h1>起動エラー</h1><p>データをリセットする必要があります。</p><button onclick="localStorage.clear(); location.reload();" style="padding:10px 20px; background:red; color:white; border-radius:10px;">データを全消去して復旧</button></div>';
            return true;
        };

        const { useState, useEffect, useMemo } = React;

        // アイコン表示の安全化
        const Icon = ({ name, size = 18, className = "" }) => {
            useEffect(() => { 
                if (typeof window !== 'undefined' && window.lucide && window.lucide.createIcons) {
                    window.lucide.createIcons(); 
                }
            }, [name]);
            return <i data-lucide={name} className={className} style={{ width: size, height: size, display: 'inline-block' }}></i>;
        };

        const CAT_IMAGES = {
            silver: "https://images.unsplash.com/photo-1513245543132-31f507417b26?auto=format&fit=crop&q=80&w=200&h=200",
            orange: "https://images.unsplash.com/photo-1514888286974-6c03e2ca1dba?auto=format&fit=crop&q=80&w=200&h=200"
        };

        const HabitTracker = () => {
            const [history, setHistory] = useState([]);
            const [inputValues, setInputValues] = useState({ hiit: "", greenEx: "", meditation: "", centering: "", pages: "", cooking: "", mission: "", meal: "" });
            const [activeTab, setActiveTab] = useState('input');
            const [lastSaved, setLastSaved] = useState("読込中...");
            
            const todayStr = new Date().toLocaleDateString('sv-SE');
            const [targetDate, setTargetDate] = useState(todayStr);

            // ポイント倍率設定（ご指定通り）
            const WEEKLY_GOAL = 500;
            const WEIGHTS = {
                cooking: 30,     // 料理: 30倍
                hiit: 20,        // HIIT: 20倍
                coldShower: 10,  // 冷水シャワー: 10倍
                bento: 10        // 弁当: 10倍
                // 他はデフォルト1倍
            };

            // 【重要】データ読み込みと修復処理
            useEffect(() => {
                try {
                    const saved = localStorage.getItem('habit-v8-magic');
                    if (saved) {
                        const parsed = JSON.parse(saved);
                        if (Array.isArray(parsed)) {
                            // データのクリーニング（壊れたデータを除外）
                            const cleanData = parsed.filter(item => {
                                // 値がオブジェクトになってしまっている不正データを除外
                                const isValueValid = typeof item.value === 'number' || typeof item.value === 'string';
                                return item && item.id && isValueValid;
                            });
                            setHistory(cleanData);
                            setLastSaved("同期完了");
                        } else {
                            // 配列でない場合は初期化
                            setHistory([]);
                            setLastSaved("初期化済");
                        }
                    } else {
                        setLastSaved("新規開始");
                    }
                } catch
